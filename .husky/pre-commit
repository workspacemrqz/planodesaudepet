#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Executando verificaÃ§Ãµes de pre-commit..."

# Verificar se hÃ¡ mudanÃ§as nÃ£o commitadas
if [ -n "$(git status --porcelain)" ]; then
  echo "âš ï¸ HÃ¡ mudanÃ§as nÃ£o commitadas. Verificando arquivos modificados..."
  
  # Obter lista de arquivos modificados
  STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|css|scss|md)$')
  
  if [ -n "$STAGED_FILES" ]; then
    echo "ğŸ“ Arquivos modificados detectados:"
    echo "$STAGED_FILES"
    
    # 1. Verificar formataÃ§Ã£o com Prettier
    echo "ğŸ¨ Verificando formataÃ§Ã£o com Prettier..."
    if ! npx prettier --check $STAGED_FILES; then
      echo "âŒ Prettier encontrou problemas de formataÃ§Ã£o."
      echo "ğŸ’¡ Execute 'npm run format' para corrigir automaticamente."
      exit 1
    fi
    echo "âœ… Prettier passou!"
    
    # 2. Verificar linting com ESLint
    echo "ğŸ”§ Verificando linting com ESLint..."
    if ! npx eslint $STAGED_FILES; then
      echo "âŒ ESLint encontrou problemas de cÃ³digo."
      echo "ğŸ’¡ Execute 'npm run lint:fix' para corrigir automaticamente."
      exit 1
    fi
    echo "âœ… ESLint passou!"
    
    # 3. Verificar tipos com TypeScript
    echo "ğŸ“˜ Verificando tipos com TypeScript..."
    if ! npx tsc --noEmit; then
      echo "âŒ TypeScript encontrou erros de tipo."
      echo "ğŸ’¡ Corrija os erros de tipo antes de fazer commit."
      exit 1
    fi
    echo "âœ… TypeScript passou!"
    
    # 4. Verificar testes unitÃ¡rios
    echo "ğŸ§ª Executando testes unitÃ¡rios..."
    if ! npm test -- --passWithNoTests --watchAll=false; then
      echo "âŒ Testes unitÃ¡rios falharam."
      echo "ğŸ’¡ Corrija os testes antes de fazer commit."
      exit 1
    fi
    echo "âœ… Testes unitÃ¡rios passaram!"
    
    # 5. Verificar build
    echo "ğŸ—ï¸ Verificando build..."
    if ! npm run build:check; then
      echo "âŒ Build falhou."
      echo "ğŸ’¡ Corrija os problemas de build antes de fazer commit."
      exit 1
    fi
    echo "âœ… Build passou!"
    
    # 6. Verificar dependÃªncias de seguranÃ§a
    echo "ğŸ”’ Verificando dependÃªncias de seguranÃ§a..."
    if ! npm audit --audit-level=moderate; then
      echo "âš ï¸ Vulnerabilidades de seguranÃ§a detectadas."
      echo "ğŸ’¡ Execute 'npm audit fix' para corrigir automaticamente."
      echo "ğŸ’¡ Ou execute 'npm audit' para ver detalhes."
      # NÃ£o bloquear commit por vulnerabilidades menores
      echo "âš ï¸ Continuando com commit (vulnerabilidades nÃ£o crÃ­ticas)..."
    else
      echo "âœ… Sem vulnerabilidades de seguranÃ§a detectadas!"
    fi
    
    # 7. Verificar tamanho do bundle (opcional)
    echo "ğŸ“Š Verificando tamanho do bundle..."
    if command -v npx >/dev/null 2>&1 && npx --yes bundle-analyzer --version >/dev/null 2>&1; then
      BUNDLE_SIZE=$(npm run build:analyze 2>/dev/null | grep -o 'bundle size: [0-9.]* [KM]B' | tail -1)
      if [ -n "$BUNDLE_SIZE" ]; then
        echo "ğŸ“¦ Tamanho do bundle: $BUNDLE_SIZE"
      fi
    else
      echo "â„¹ï¸ Bundle analyzer nÃ£o disponÃ­vel, pulando verificaÃ§Ã£o de tamanho."
    fi
    
    # 8. Verificar commits convencionais
    echo "ğŸ“ Verificando formato do commit..."
    COMMIT_MSG=$(cat .git/COMMIT_EDITMSG 2>/dev/null || echo "")
    if [ -n "$COMMIT_MSG" ]; then
      if ! echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
        echo "âš ï¸ Formato de commit nÃ£o segue convenÃ§Ãµes."
        echo "ğŸ’¡ Use o formato: type(scope): description"
        echo "ğŸ’¡ Exemplos: feat(auth): add login functionality"
        echo "ğŸ’¡ Tipos vÃ¡lidos: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
        # NÃ£o bloquear commit por formato
        echo "âš ï¸ Continuando com commit (formato nÃ£o crÃ­tico)..."
      else
        echo "âœ… Formato de commit vÃ¡lido!"
      fi
    fi
    
    # 9. Verificar arquivos grandes
    echo "ğŸ“ Verificando tamanho dos arquivos..."
    LARGE_FILES=$(find . -type f -size +1M -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./dist/*" -not -path "./build/*" 2>/dev/null | head -5)
    if [ -n "$LARGE_FILES" ]; then
      echo "âš ï¸ Arquivos grandes detectados:"
      echo "$LARGE_FILES"
      echo "ğŸ’¡ Considere otimizar ou adicionar ao .gitignore se apropriado."
    else
      echo "âœ… Sem arquivos grandes detectados!"
    fi
    
    # 10. Verificar merge conflicts
    echo "ğŸ”€ Verificando conflitos de merge..."
    if git diff --name-only --diff-filter=U | grep -q .; then
      echo "âŒ Conflitos de merge detectados!"
      echo "ğŸ’¡ Resolva os conflitos antes de fazer commit."
      exit 1
    fi
    echo "âœ… Sem conflitos de merge!"
    
    echo "ğŸ‰ Todas as verificaÃ§Ãµes de pre-commit passaram!"
    echo "âœ… Commit permitido."
    
  else
    echo "â„¹ï¸ Nenhum arquivo de cÃ³digo modificado detectado."
    echo "âœ… Commit permitido."
  fi
  
else
  echo "â„¹ï¸ Nenhuma mudanÃ§a detectada para commit."
  echo "âœ… Commit permitido."
fi

echo "ğŸš€ Pre-commit hook concluÃ­do com sucesso!"
