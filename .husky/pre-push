#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Executando verificaÃ§Ãµes de pre-push..."

# Verificar se hÃ¡ mudanÃ§as nÃ£o commitadas
if [ -n "$(git status --porcelain)" ]; then
  echo "âŒ HÃ¡ mudanÃ§as nÃ£o commitadas."
  echo "ğŸ’¡ FaÃ§a commit de todas as mudanÃ§as antes de fazer push."
  echo "ğŸ’¡ Use 'git add .' e 'git commit -m \"message\"'"
  exit 1
fi

# Verificar se hÃ¡ commits nÃ£o enviados
if [ -n "$(git log --branches --not --remotes)" ]; then
  echo "ğŸ“¤ Detectados commits locais nÃ£o enviados."
  
  # Contar commits nÃ£o enviados
  COMMIT_COUNT=$(git log --branches --not --remotes --oneline | wc -l)
  echo "ğŸ“Š Total de commits nÃ£o enviados: $COMMIT_COUNT"
  
  # Mostrar Ãºltimos commits
  echo "ğŸ“ Ãšltimos commits nÃ£o enviados:"
  git log --branches --not --remotes --oneline -5
  
  # Verificar se hÃ¡ muitos commits
  if [ "$COMMIT_COUNT" -gt 10 ]; then
    echo "âš ï¸ Muitos commits nÃ£o enviados detectados ($COMMIT_COUNT)."
    echo "ğŸ’¡ Considere fazer push mais frequentemente ou usar squash."
    echo "ğŸ’¡ Continuando com push..."
  fi
else
  echo "â„¹ï¸ Todos os commits jÃ¡ foram enviados."
fi

# Verificar se o branch atual estÃ¡ atualizado
echo "ğŸ”„ Verificando se o branch estÃ¡ atualizado..."
git fetch origin

if [ -n "$(git log HEAD..origin/$(git branch --show-current) --oneline)" ]; then
  echo "âš ï¸ O branch remoto tem commits mais recentes."
  echo "ğŸ’¡ Execute 'git pull' antes de fazer push."
  echo "ğŸ’¡ Ou use 'git push --force-with-lease' se tiver certeza."
  
  # Perguntar se deve continuar (em modo interativo)
  if [ -t 0 ]; then
    read -p "Deseja continuar com o push? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo "âŒ Push cancelado pelo usuÃ¡rio."
      exit 1
    fi
  else
    echo "âš ï¸ Modo nÃ£o interativo, continuando com push..."
  fi
else
  echo "âœ… Branch estÃ¡ atualizado."
fi

# Verificar se hÃ¡ conflitos de merge
echo "ğŸ”€ Verificando conflitos de merge..."
if git diff --name-only --diff-filter=U | grep -q .; then
  echo "âŒ Conflitos de merge detectados!"
  echo "ğŸ’¡ Resolva os conflitos antes de fazer push."
  exit 1
fi
echo "âœ… Sem conflitos de merge."

# Verificar se hÃ¡ rebase em andamento
echo "ğŸ”„ Verificando rebase em andamento..."
if [ -d ".git/rebase-merge" ] || [ -d ".git/rebase-apply" ]; then
  echo "âŒ Rebase em andamento detectado!"
  echo "ğŸ’¡ Complete ou aborte o rebase antes de fazer push."
  exit 1
fi
echo "âœ… Sem rebase em andamento."

# Verificar se hÃ¡ cherry-pick em andamento
echo "ğŸ’ Verificando cherry-pick em andamento..."
if [ -d ".git/CHERRY_PICK_HEAD" ]; then
  echo "âŒ Cherry-pick em andamento detectado!"
  echo "ğŸ’¡ Complete ou aborte o cherry-pick antes de fazer push."
  exit 1
fi
echo "âœ… Sem cherry-pick em andamento."

# Verificar se hÃ¡ merge em andamento
echo "ğŸ”€ Verificando merge em andamento..."
if [ -d ".git/MERGE_HEAD" ]; then
  echo "âŒ Merge em andamento detectado!"
  echo "ğŸ’¡ Complete ou aborte o merge antes de fazer push."
  exit 1
fi
echo "âœ… Sem merge em andamento."

# Verificar se hÃ¡ stash nÃ£o aplicado
echo "ğŸ“¦ Verificando stash nÃ£o aplicado..."
if [ -n "$(git stash list)" ]; then
  STASH_COUNT=$(git stash list | wc -l)
  echo "âš ï¸ HÃ¡ $STASH_COUNT stash(es) nÃ£o aplicado(s)."
  echo "ğŸ’¡ Considere aplicar ou limpar stashes antes de fazer push."
  echo "ğŸ’¡ Continuando com push..."
else
  echo "âœ… Sem stash nÃ£o aplicado."
fi

# Verificar se hÃ¡ tags nÃ£o enviadas
echo "ğŸ·ï¸ Verificando tags nÃ£o enviadas..."
if [ -n "$(git tag --list --no-merged)" ]; then
  TAG_COUNT=$(git tag --list --no-merged | wc -l)
  echo "âš ï¸ HÃ¡ $TAG_COUNT tag(s) nÃ£o enviada(s)."
  echo "ğŸ’¡ Considere enviar tags importantes: 'git push --tags'"
  echo "ğŸ’¡ Continuando com push..."
else
  echo "âœ… Todas as tags foram enviadas."
fi

# Verificar se hÃ¡ branches locais nÃ£o enviados
echo "ğŸŒ¿ Verificando branches locais nÃ£o enviados..."
LOCAL_BRANCHES=$(git branch --list --no-merged | grep -v "^\*" | wc -l)
if [ "$LOCAL_BRANCHES" -gt 0 ]; then
  echo "âš ï¸ HÃ¡ $LOCAL_BRANCHES branch(es) local(is) nÃ£o enviado(s)."
  echo "ğŸ’¡ Considere enviar branches importantes ou removÃª-los."
  echo "ğŸ’¡ Continuando com push..."
else
  echo "âœ… Todos os branches foram enviados."
fi

# Verificar se hÃ¡ arquivos grandes
echo "ğŸ“ Verificando arquivos grandes..."
LARGE_FILES=$(find . -type f -size +10M -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./dist/*" -not -path "./build/*" -not -path "./uploads/*" 2>/dev/null | head -3)
if [ -n "$LARGE_FILES" ]; then
  echo "âš ï¸ Arquivos grandes detectados:"
  echo "$LARGE_FILES"
  echo "ğŸ’¡ Considere adicionar ao .gitignore ou usar Git LFS."
  echo "ğŸ’¡ Continuando com push..."
else
  echo "âœ… Sem arquivos grandes detectados."
fi

# Verificar se hÃ¡ arquivos binÃ¡rios
echo "ğŸ” Verificando arquivos binÃ¡rios..."
BINARY_FILES=$(git diff --cached --name-only | xargs file 2>/dev/null | grep -E "executable|binary" | head -3)
if [ -n "$BINARY_FILES" ]; then
  echo "âš ï¸ Arquivos binÃ¡rios detectados:"
  echo "$BINARY_FILES"
  echo "ğŸ’¡ Considere usar Git LFS para arquivos binÃ¡rios."
  echo "ğŸ’¡ Continuando com push..."
else
  echo "âœ… Sem arquivos binÃ¡rios detectados."
fi

# Verificar se hÃ¡ arquivos de configuraÃ§Ã£o sensÃ­veis
echo "ğŸ”’ Verificando arquivos de configuraÃ§Ã£o sensÃ­veis..."
SENSITIVE_FILES=$(git diff --cached --name-only | grep -E "\.(env|config|key|pem|p12|pfx|pwd|secret|token|credential)" | head -3)
if [ -n "$SENSITIVE_FILES" ]; then
  echo "âŒ Arquivos sensÃ­veis detectados no commit!"
  echo "$SENSITIVE_FILES"
  echo "ğŸ’¡ NUNCA faÃ§a commit de arquivos com informaÃ§Ãµes sensÃ­veis."
  echo "ğŸ’¡ Use variÃ¡veis de ambiente ou arquivos env.example."
  echo "ğŸ’¡ Remova os arquivos do commit: 'git reset HEAD <arquivo>'"
  exit 1
else
  echo "âœ… Sem arquivos sensÃ­veis detectados."
fi

# Verificar se hÃ¡ arquivos de log
echo "ğŸ“‹ Verificando arquivos de log..."
LOG_FILES=$(git diff --cached --name-only | grep -E "\.(log|out|err|tmp|temp|cache)" | head -3)
if [ -n "$LOG_FILES" ]; then
  echo "âš ï¸ Arquivos de log detectados no commit!"
  echo "$LOG_FILES"
  echo "ğŸ’¡ Considere adicionar ao .gitignore: *.log, *.out, *.err, *.tmp"
  echo "ğŸ’¡ Continuando com push..."
else
  echo "âœ… Sem arquivos de log detectados."
fi

# Verificar se hÃ¡ arquivos de sistema
echo "ğŸ’» Verificando arquivos de sistema..."
SYSTEM_FILES=$(git diff --cached --name-only | grep -E "\.(DS_Store|Thumbs\.db|desktop\.ini|\.swp|\.swo|\.bak|\.old|\.orig)" | head -3)
if [ -n "$SYSTEM_FILES" ]; then
  echo "âš ï¸ Arquivos de sistema detectados no commit!"
  echo "$SYSTEM_FILES"
  echo "ğŸ’¡ Adicione ao .gitignore: .DS_Store, Thumbs.db, *.bak, *.old"
  echo "ğŸ’¡ Continuando com push..."
else
  echo "âœ… Sem arquivos de sistema detectados."
fi

# Verificar se hÃ¡ dependÃªncias nÃ£o atualizadas
echo "ğŸ“¦ Verificando dependÃªncias..."
if [ -f "package.json" ]; then
  echo "ğŸ” Verificando package.json..."
  
  # Verificar se hÃ¡ dependÃªncias desatualizadas
  if command -v npm-check-updates >/dev/null 2>&1; then
    OUTDATED_COUNT=$(npx npm-check-updates --json 2>/dev/null | jq 'length' 2>/dev/null || echo "0")
    if [ "$OUTDATED_COUNT" -gt 0 ]; then
      echo "âš ï¸ $OUTDATED_COUNT dependÃªncia(s) desatualizada(s) detectada(s)."
      echo "ğŸ’¡ Execute 'npx npm-check-updates' para ver detalhes."
      echo "ğŸ’¡ Continuando com push..."
    else
      echo "âœ… DependÃªncias estÃ£o atualizadas."
    fi
  else
    echo "â„¹ï¸ npm-check-updates nÃ£o disponÃ­vel, pulando verificaÃ§Ã£o."
  fi
  
  # Verificar se hÃ¡ vulnerabilidades
  if npm audit --audit-level=high >/dev/null 2>&1; then
    echo "âœ… Sem vulnerabilidades crÃ­ticas detectadas."
  else
    echo "âš ï¸ Vulnerabilidades de seguranÃ§a detectadas."
    echo "ğŸ’¡ Execute 'npm audit fix' para corrigir."
    echo "ğŸ’¡ Continuando com push..."
  fi
else
  echo "â„¹ï¸ package.json nÃ£o encontrado, pulando verificaÃ§Ã£o de dependÃªncias."
fi

# Verificar se hÃ¡ testes falhando
echo "ğŸ§ª Verificando testes..."
if [ -f "package.json" ] && grep -q '"test"' package.json; then
  echo "ğŸ” Executando testes..."
  if npm test -- --passWithNoTests --watchAll=false >/dev/null 2>&1; then
    echo "âœ… Todos os testes passaram!"
  else
    echo "âŒ Testes falharam!"
    echo "ğŸ’¡ Corrija os testes antes de fazer push."
    exit 1
  fi
else
  echo "â„¹ï¸ Script de teste nÃ£o encontrado, pulando verificaÃ§Ã£o."
fi

# Verificar se hÃ¡ problemas de build
echo "ğŸ—ï¸ Verificando build..."
if [ -f "package.json" ] && grep -q '"build"' package.json; then
  echo "ğŸ” Executando build..."
  if npm run build >/dev/null 2>&1; then
    echo "âœ… Build executado com sucesso!"
  else
    echo "âŒ Build falhou!"
    echo "ğŸ’¡ Corrija os problemas de build antes de fazer push."
    exit 1
  fi
else
  echo "â„¹ï¸ Script de build nÃ£o encontrado, pulando verificaÃ§Ã£o."
fi

# Verificar se hÃ¡ problemas de linting
echo "ğŸ”§ Verificando linting..."
if [ -f "package.json" ] && grep -q '"lint"' package.json; then
  echo "ğŸ” Executando linting..."
  if npm run lint >/dev/null 2>&1; then
    echo "âœ… Linting passou!"
  else
    echo "âŒ Linting falhou!"
    echo "ğŸ’¡ Corrija os problemas de linting antes de fazer push."
    exit 1
  fi
else
  echo "â„¹ï¸ Script de linting nÃ£o encontrado, pulando verificaÃ§Ã£o."
fi

# Verificar se hÃ¡ problemas de formataÃ§Ã£o
echo "ğŸ¨ Verificando formataÃ§Ã£o..."
if [ -f "package.json" ] && grep -q '"format"' package.json; then
  echo "ğŸ” Verificando formataÃ§Ã£o..."
  if npm run format:check >/dev/null 2>&1; then
    echo "âœ… FormataÃ§Ã£o estÃ¡ correta!"
  else
    echo "âŒ FormataÃ§Ã£o incorreta!"
    echo "ğŸ’¡ Execute 'npm run format' para corrigir automaticamente."
    exit 1
  fi
else
  echo "â„¹ï¸ Script de formataÃ§Ã£o nÃ£o encontrado, pulando verificaÃ§Ã£o."
fi

# Verificar se hÃ¡ problemas de tipos
echo "ğŸ“˜ Verificando tipos..."
if [ -f "tsconfig.json" ]; then
  echo "ğŸ” Verificando tipos TypeScript..."
  if npx tsc --noEmit >/dev/null 2>&1; then
    echo "âœ… VerificaÃ§Ã£o de tipos passou!"
  else
    echo "âŒ VerificaÃ§Ã£o de tipos falhou!"
    echo "ğŸ’¡ Corrija os erros de tipo antes de fazer push."
    exit 1
  fi
else
  echo "â„¹ï¸ tsconfig.json nÃ£o encontrado, pulando verificaÃ§Ã£o de tipos."
fi

# Verificar se hÃ¡ problemas de seguranÃ§a
echo "ğŸ”’ Verificando seguranÃ§a..."
if [ -f "package.json" ]; then
  echo "ğŸ” Verificando vulnerabilidades..."
  if npm audit --audit-level=moderate >/dev/null 2>&1; then
    echo "âœ… Sem vulnerabilidades crÃ­ticas detectadas!"
  else
    echo "âš ï¸ Vulnerabilidades de seguranÃ§a detectadas."
    echo "ğŸ’¡ Execute 'npm audit fix' para corrigir."
    echo "ğŸ’¡ Continuando com push..."
  fi
else
  echo "â„¹ï¸ package.json nÃ£o encontrado, pulando verificaÃ§Ã£o de seguranÃ§a."
fi

# Verificar se hÃ¡ problemas de performance
echo "âš¡ Verificando performance..."
if [ -f "package.json" ] && grep -q '"build"' package.json; then
  echo "ğŸ” Verificando tamanho do bundle..."
  
  # Verificar se hÃ¡ bundle analyzer
  if [ -f "dist" ] || [ -f "build" ]; then
    BUNDLE_SIZE=$(du -sh dist build 2>/dev/null | head -1 | cut -f1)
    if [ -n "$BUNDLE_SIZE" ]; then
      echo "ğŸ“¦ Tamanho do bundle: $BUNDLE_SIZE"
      
      # Verificar se o bundle Ã© muito grande (mais de 5MB)
      if echo "$BUNDLE_SIZE" | grep -q "M" && [ "$(echo "$BUNDLE_SIZE" | sed 's/M//')" -gt 5 ]; then
        echo "âš ï¸ Bundle muito grande detectado!"
        echo "ğŸ’¡ Considere otimizar o tamanho do bundle."
        echo "ğŸ’¡ Use code splitting, tree shaking, etc."
        echo "ğŸ’¡ Continuando com push..."
      else
        echo "âœ… Tamanho do bundle aceitÃ¡vel."
      fi
    fi
  fi
else
  echo "â„¹ï¸ Build nÃ£o encontrado, pulando verificaÃ§Ã£o de performance."
fi

echo "ğŸ‰ Todas as verificaÃ§Ãµes de pre-push passaram!"
echo "âœ… Push permitido."

# Mostrar resumo final
echo ""
echo "ğŸ“Š Resumo das verificaÃ§Ãµes:"
echo "âœ… Status do repositÃ³rio: Limpo"
echo "âœ… Conflitos: Nenhum"
echo "âœ… Rebase/Merge: Nenhum em andamento"
echo "âœ… Testes: Passaram"
echo "âœ… Build: Sucesso"
echo "âœ… Linting: Passou"
echo "âœ… FormataÃ§Ã£o: Correta"
echo "âœ… Tipos: VÃ¡lidos"
echo "âœ… SeguranÃ§a: Sem vulnerabilidades crÃ­ticas"
echo "âœ… Performance: AceitÃ¡vel"
echo ""
echo "ğŸš€ Pronto para fazer push!"

exit 0
