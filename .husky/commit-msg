#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ðŸ“ Validando mensagem de commit..."

# Obter a mensagem de commit
COMMIT_MSG=$(cat "$1")

# Verificar se a mensagem estÃ¡ vazia
if [ -z "$COMMIT_MSG" ]; then
  echo "âŒ Mensagem de commit nÃ£o pode estar vazia."
  exit 1
fi

# Verificar se a mensagem Ã© muito longa
if [ ${#COMMIT_MSG} -gt 100 ]; then
  echo "âŒ Mensagem de commit muito longa (mÃ¡ximo 100 caracteres)."
  echo "ðŸ’¡ Mensagem atual: ${#COMMIT_MSG} caracteres"
  echo "ðŸ’¡ Exemplo de formato: feat(auth): add login functionality"
  exit 1
fi

# Verificar se a mensagem Ã© muito curta
if [ ${#COMMIT_MSG} -lt 10 ]; then
  echo "âŒ Mensagem de commit muito curta (mÃ­nimo 10 caracteres)."
  echo "ðŸ’¡ Mensagem atual: ${#COMMIT_MSG} caracteres"
  echo "ðŸ’¡ Exemplo de formato: feat(auth): add login functionality"
  exit 1
fi

# Verificar formato convencional de commits
if ! echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert|hotfix|security)(\([a-z0-9-]+\))?: .+'; then
  echo "âŒ Formato de commit invÃ¡lido."
  echo "ðŸ’¡ Use o formato: type(scope): description"
  echo "ðŸ’¡ Exemplos vÃ¡lidos:"
  echo "   - feat(auth): add login functionality"
  echo "   - fix(api): resolve user authentication issue"
  echo "   - docs(readme): update installation instructions"
  echo "   - style(ui): improve button styling"
  echo "   - refactor(utils): simplify date formatting"
  echo "   - test(auth): add unit tests for login"
  echo "   - chore(deps): update dependencies"
  echo "   - perf(api): optimize database queries"
  echo "   - ci(github): add automated testing"
  echo "   - build(vite): configure production build"
  echo "   - revert(auth): revert login changes"
  echo "   - hotfix(api): fix critical authentication bug"
  echo "   - security(auth): fix XSS vulnerability"
  echo ""
  echo "ðŸ’¡ Tipos vÃ¡lidos:"
  echo "   - feat: nova funcionalidade"
  echo "   - fix: correÃ§Ã£o de bug"
  echo "   - docs: documentaÃ§Ã£o"
  echo "   - style: formataÃ§Ã£o de cÃ³digo"
  echo "   - refactor: refatoraÃ§Ã£o de cÃ³digo"
  echo "   - test: testes"
  echo "   - chore: tarefas de manutenÃ§Ã£o"
  echo "   - perf: melhorias de performance"
  echo "   - ci: integraÃ§Ã£o contÃ­nua"
  echo "   - build: build e deploy"
  echo "   - revert: reverter mudanÃ§as"
  echo "   - hotfix: correÃ§Ã£o urgente"
  echo "   - security: correÃ§Ãµes de seguranÃ§a"
  echo ""
  echo "ðŸ’¡ Escopo (opcional):"
  echo "   - auth: autenticaÃ§Ã£o"
  echo "   - api: API backend"
  echo "   - ui: interface do usuÃ¡rio"
  echo "   - utils: utilitÃ¡rios"
  echo "   - deps: dependÃªncias"
  echo "   - github: configuraÃ§Ãµes do GitHub"
  echo "   - vite: configuraÃ§Ãµes do Vite"
  echo ""
  echo "ðŸ’¡ DescriÃ§Ã£o:"
  echo "   - Use imperativo (add, fix, update, etc.)"
  echo "   - Seja claro e conciso"
  echo "   - Use minÃºsculas"
  echo "   - NÃ£o termine com ponto"
  exit 1
fi

# Verificar se a descriÃ§Ã£o comeÃ§a com maiÃºscula
if ! echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert|hotfix|security)(\([a-z0-9-]+\))?: [A-Z].+'; then
  echo "âš ï¸ Aviso: DescriÃ§Ã£o deve comeÃ§ar com maiÃºscula."
  echo "ðŸ’¡ Exemplo: feat(auth): Add login functionality"
  echo "ðŸ’¡ Continuando com commit..."
fi

# Verificar se a descriÃ§Ã£o termina com ponto
if echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert|hotfix|security)(\([a-z0-9-]+\))?: .+\.$'; then
  echo "âš ï¸ Aviso: DescriÃ§Ã£o nÃ£o deve terminar com ponto."
  echo "ðŸ’¡ Exemplo: feat(auth): Add login functionality"
  echo "ðŸ’¡ Continuando com commit..."
fi

# Verificar se hÃ¡ palavras proibidas
PROHIBITED_WORDS="WIP|TODO|FIXME|HACK|XXX|BUG|TEMP|DEBUG|CONSOLE|ALERT"
if echo "$COMMIT_MSG" | grep -qiE "($PROHIBITED_WORDS)"; then
  echo "âš ï¸ Aviso: Mensagem contÃ©m palavras que podem indicar trabalho incompleto."
  echo "ðŸ’¡ Palavras detectadas: $(echo "$COMMIT_MSG" | grep -oiE "($PROHIBITED_WORDS)" | tr '\n' ' ')"
  echo "ðŸ’¡ Considere usar um commit temporÃ¡rio ou completar o trabalho."
  echo "ðŸ’¡ Continuando com commit..."
fi

# Verificar se hÃ¡ emojis (opcional)
if echo "$COMMIT_MSG" | grep -qE '[ðŸš€ðŸ”§ðŸ›ðŸ“ðŸŽ¨â™»ï¸âœ…ðŸ”’ðŸ”¥âš¡ðŸš¨]'; then
  echo "â„¹ï¸ Emojis detectados na mensagem de commit."
  echo "ðŸ’¡ Isso Ã© opcional, mas pode tornar os commits mais legÃ­veis."
fi

# Verificar se Ã© um commit de merge ou revert
if echo "$COMMIT_MSG" | grep -qE '^Merge|^Revert'; then
  echo "â„¹ï¸ Commit de merge ou revert detectado."
  echo "âœ… Pulando validaÃ§Ãµes de formato para commits especiais."
  exit 0
fi

# Verificar se Ã© um commit de release
if echo "$COMMIT_MSG" | grep -qE '^release|^v[0-9]+\.[0-9]+\.[0-9]+'; then
  echo "â„¹ï¸ Commit de release detectado."
  echo "âœ… Pulando validaÃ§Ãµes de formato para releases."
  exit 0
fi

# Verificar se Ã© um commit de hotfix
if echo "$COMMIT_MSG" | grep -qE '^hotfix'; then
  echo "â„¹ï¸ Commit de hotfix detectado."
  echo "âœ… Validando formato de hotfix..."
  
  # Validar formato especÃ­fico de hotfix
  if ! echo "$COMMIT_MSG" | grep -qE '^hotfix\([a-z0-9-]+\): [A-Z].+'; then
    echo "âŒ Formato de hotfix invÃ¡lido."
    echo "ðŸ’¡ Use: hotfix(scope): Description of the fix"
    echo "ðŸ’¡ Exemplo: hotfix(auth): Fix critical login issue"
    exit 1
  fi
fi

# Verificar se Ã© um commit de seguranÃ§a
if echo "$COMMIT_MSG" | grep -qE '^security'; then
  echo "â„¹ï¸ Commit de seguranÃ§a detectado."
  echo "âœ… Validando formato de seguranÃ§a..."
  
  # Validar formato especÃ­fico de seguranÃ§a
  if ! echo "$COMMIT_MSG" | grep -qE '^security\([a-z0-9-]+\): [A-Z].+'; then
    echo "âŒ Formato de seguranÃ§a invÃ¡lido."
    echo "ðŸ’¡ Use: security(scope): Description of the security fix"
    echo "ðŸ’¡ Exemplo: security(auth): Fix XSS vulnerability in login form"
    exit 1
  fi
fi

# Verificar se hÃ¡ duplicaÃ§Ã£o de palavras
WORDS=$(echo "$COMMIT_MSG" | sed 's/^[^:]*: //' | tr ' ' '\n' | sort | uniq -d)
if [ -n "$WORDS" ]; then
  echo "âš ï¸ Aviso: Palavras duplicadas detectadas na descriÃ§Ã£o."
  echo "ðŸ’¡ Palavras duplicadas: $(echo "$WORDS" | tr '\n' ' ')"
  echo "ðŸ’¡ Considere reescrever para evitar repetiÃ§Ã£o."
  echo "ðŸ’¡ Continuando com commit..."
fi

# Verificar se hÃ¡ URLs ou caminhos de arquivo
if echo "$COMMIT_MSG" | grep -qE 'https?://|\.(js|ts|tsx|jsx|css|scss|html|json|md|yml|yaml)$'; then
  echo "âš ï¸ Aviso: URLs ou caminhos de arquivo detectados na mensagem."
  echo "ðŸ’¡ Considere usar descriÃ§Ãµes mais genÃ©ricas."
  echo "ðŸ’¡ Continuando com commit..."
fi

# Verificar se hÃ¡ nÃºmeros de issue ou PR
if echo "$COMMIT_MSG" | grep -qE '#[0-9]+|#[0-9]+|issue #[0-9]+|PR #[0-9]+'; then
  echo "â„¹ï¸ ReferÃªncias a issues ou PRs detectadas."
  echo "ðŸ’¡ Isso Ã© uma boa prÃ¡tica para rastreamento."
fi

# Verificar se hÃ¡ quebras de linha desnecessÃ¡rias
if echo "$COMMIT_MSG" | grep -qE '\n\n'; then
  echo "âš ï¸ Aviso: Quebras de linha desnecessÃ¡rias detectadas."
  echo "ðŸ’¡ Use apenas uma linha para a mensagem principal."
  echo "ðŸ’¡ Use o corpo do commit para detalhes adicionais."
  echo "ðŸ’¡ Continuando com commit..."
fi

echo "âœ… Mensagem de commit vÃ¡lida!"
echo "ðŸŽ‰ Commit permitido."

# Salvar mensagem de commit para uso em outros hooks
echo "$COMMIT_MSG" > .git/COMMIT_EDITMSG

exit 0
